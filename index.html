
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIS/TIS PDF to Excel Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #2c3e50; }
    button { margin: 5px; padding: 10px; border-radius: 6px; cursor: pointer; }
    #preview { margin-top: 20px; max-height: 400px; overflow: auto; border: 1px solid #ccc; padding: 10px; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { border: 1px solid #ddd; padding: 4px; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>
  <h2>AIS / TIS PDF â†’ Excel Converter</h2>
  <input type="file" id="pdfFile" accept="application/pdf"><br>
  <input type="text" id="password" placeholder="Enter password (pan+ddmmyyyy)" size="40"><br>
  <button id="parseBtn">Parse & Preview</button>
  <button id="downloadBtn" disabled>Download Excel</button>
  <div id="status"></div>
  <div id="preview"></div>

<script>
const parseBtn = document.getElementById("parseBtn");
const downloadBtn = document.getElementById("downloadBtn");
const statusDiv = document.getElementById("status");
const previewDiv = document.getElementById("preview");

let parsedData = {};

parseBtn.addEventListener("click", async () => {
  const file = document.getElementById("pdfFile").files[0];
  if (!file) { alert("Upload a PDF file"); return; }
  const password = document.getElementById("password").value.trim();
  statusDiv.innerHTML = "Parsing... please wait";
  parsedData = { AIS: [], TIS: [] };

  const reader = new FileReader();
  reader.onload = async function() {
    const typedarray = new Uint8Array(this.result);
    try {
      const pdf = await pdfjsLib.getDocument({data: typedarray, password}).promise;
      let allText = "";
      for (let i=1; i<=pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const text = await page.getTextContent();
        const strings = text.items.map(item => item.str);
        allText += strings.join(" ") + "\n";
      }
      processText(allText);
    } catch (err) {
      statusDiv.innerHTML = "<span style='color:red'>Error: " + err.message + "</span>";
    }
  };
  reader.readAsArrayBuffer(file);
});

function processText(text) {
  const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l);
  let mode = null;
  for (let line of lines) {
    if (line.includes("INFORMATION CODE") || line.includes("INFORMATION DESCRIPTION")) {
      mode = "AIS"; continue;
    }
    if (line.includes("INFORMATION CATEGORY") || line.includes("PROCESSED BY SYSTEM")) {
      mode = "TIS"; continue;
    }
    if (!mode) continue;
    if (mode === "AIS") parsedData.AIS.push(line.split(/\s{2,}/));
    if (mode === "TIS") parsedData.TIS.push(line.split(/\s{2,}/));
  }
  if (parsedData.AIS.length === 0 && parsedData.TIS.length === 0) {
    // fallback generic mode
    parsedData.Generic = lines.map((l,i)=>[i+1,l]);
    statusDiv.innerHTML = "<span style='color:orange'>Fallback: Generic mode</span>";
  } else {
    statusDiv.innerHTML = "<span style='color:green'>Parsed successfully!</span>";
  }
  showPreview();
  downloadBtn.disabled = false;
}

function showPreview() {
  previewDiv.innerHTML = "";
  for (let key in parsedData) {
    const data = parsedData[key];
    if (data.length === 0) continue;
    const table = document.createElement("table");
    const header = document.createElement("tr");
    header.innerHTML = "<th colspan='10'>" + key + " Preview ("+data.length+" rows)</th>";
    table.appendChild(header);
    data.slice(0,200).forEach(row => {
      const tr = document.createElement("tr");
      row.forEach(cell => {
        const td = document.createElement("td");
        td.textContent = cell;
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });
    previewDiv.appendChild(table);
  }
}

downloadBtn.addEventListener("click", () => {
  const wb = XLSX.utils.book_new();
  for (let key in parsedData) {
    if (parsedData[key].length === 0) continue;
    const ws = XLSX.utils.aoa_to_sheet(parsedData[key]);
    XLSX.utils.book_append_sheet(wb, ws, key.substring(0,30));
  }
  XLSX.writeFile(wb, "AIS-TIS.xlsx");
});
</script>
</body>
</html>
