
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIS/TIS PDF to Excel Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    button { padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0d47a1; }
    input { margin: 10px 0; padding: 8px; width: 300px; }
  </style>
</head>
<body>
  <h2>AIS / TIS PDF â†’ Excel Converter</h2>
  <input type="file" id="pdfFile" accept="application/pdf"><br>
  <input type="text" id="password" placeholder="Enter password (pan+ddmmyyyy)"><br>
  <button onclick="convertToExcel()">Convert to Excel</button>
  <p id="status"></p>

  <script>
    async function convertToExcel() {
      const fileInput = document.getElementById("pdfFile");
      const password = document.getElementById("password").value.trim();
      const status = document.getElementById("status");

      if (!fileInput.files.length) {
        status.innerText = "Please select a PDF file.";
        return;
      }

      status.innerText = "Processing... Please wait.";

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function(e) {
        const typedarray = new Uint8Array(e.target.result);

        try {
          const pdf = await pdfjsLib.getDocument({ data: typedarray, password: password }).promise;
          let extractedRows = [];
          let srNo = 1;

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();

            // Group words into lines by Y coordinate
            let lines = {};
            textContent.items.forEach(item => {
              let y = Math.round(item.transform[5]); // vertical position
              if (!lines[y]) lines[y] = [];
              lines[y].push(item);
            });

            // Process each line into columns
            Object.values(lines).forEach(lineItems => {
              lineItems.sort((a, b) => a.transform[4] - b.transform[4]); // sort by X
              const lineText = lineItems.map(it => it.str.trim()).filter(Boolean);

              // Expect at least 6 columns for valid data
              if (lineText.length >= 6) {
                extractedRows.push([
                  srNo++,
                  lineText[0] || "",
                  lineText[1] || "",
                  lineText[2] || "",
                  lineText[3] || "",
                  lineText[4] || "",
                  lineText[5] || ""
                ]);
              }
            });
          }

          // Create workbook
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet([
            ["SR. NO.","INFORMATION CODE","INFORMATION DESCRIPTION","INFORMATION SOURCE","DATE OF PAYMENT/CREDIT","AMOUNT PAID/CREDITED","TDS DEDUCTED"],
            ...extractedRows
          ]);
          XLSX.utils.book_append_sheet(wb, ws, "Extracted Data");

          // Summary Sheet (sum by INFO CODE)
          let summary = {};
          extractedRows.forEach(r => {
            let code = r[1];
            let amt = parseFloat(r[5].replace(/,/g,"")) || 0;
            let tds = parseFloat(r[6].replace(/,/g,"")) || 0;
            if (!summary[code]) summary[code] = { amt: 0, tds: 0 };
            summary[code].amt += amt;
            summary[code].tds += tds;
          });

          const summaryRows = [["INFORMATION CODE","TOTAL AMOUNT","TOTAL TDS"]];
          Object.entries(summary).forEach(([code, vals]) => {
            summaryRows.push([code, vals.amt, vals.tds]);
          });
          const ws2 = XLSX.utils.aoa_to_sheet(summaryRows);
          XLSX.utils.book_append_sheet(wb, ws2, "Summary");

          XLSX.writeFile(wb, "AIS_TIS_Extract.xlsx");
          status.innerText = "Excel generated successfully!";
        } catch (err) {
          status.innerText = "Error: " + err.message;
        }
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
